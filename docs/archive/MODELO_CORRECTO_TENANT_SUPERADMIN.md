# üèóÔ∏è Modelo Correcto: TENANT ‚Üí SUPERADMIN ‚Üí AGENCIES

## üéØ Arquitectura Correcta

```
OWNER (Sistema Global)
  ‚Üì crea
TENANT (Mayorista/Organizaci√≥n)
  ‚Üì tiene
SUPERADMIN (Administrador del Tenant)
  ‚Üì gestiona TODAS
AGENCIES (Agencias del Tenant)
  ‚Üì tienen
ADMINS y SELLERS
```

---

## üìä Modelo de Datos

### Tabla: `users`

| Campo | OWNER | SUPERADMIN | ADMIN | SELLER |
|-------|-------|------------|-------|--------|
| `tenant_id` | `NULL` | `tenant-uuid` ‚úÖ | `tenant-uuid` | `tenant-uuid` |
| `agency_id` | `NULL` | `NULL` ‚úÖ | `agency-uuid` | `agency-uuid` |

**Regla clave:**
- ‚úÖ **SUPERADMIN tiene `tenant_id` pero `agency_id = NULL`**
- ‚úÖ **ADMIN/SELLER tienen AMBOS `tenant_id` Y `agency_id`**

---

## üîê Pol√≠ticas RLS Correctas

### SELECT Policy

```sql
CREATE POLICY "users_select_policy" ON public.users FOR SELECT TO authenticated
USING (
  id = auth.uid()                    -- Ve s√≠ mismo
  OR public.is_owner()               -- OWNER ve todo
  OR (
    -- SUPERADMIN ve usuarios de SU TENANT (todas las agencias)
    public.get_user_role() = 'SUPERADMIN'
    AND tenant_id = public.get_user_tenant_id()  -- ‚Üê KEY: Filtra por TENANT
  )
  OR (
    -- ADMIN ve SELLERS de su agencia
    public.get_user_role() = 'ADMIN'
    AND agency_id = public.get_user_agency_id()
    AND role = 'SELLER'::public.user_role
  )
);
```

**Explicaci√≥n:**
- SUPERADMIN: `WHERE tenant_id = 'mi-tenant-uuid'` ‚Üí Ve TODAS las agencias del tenant
- ADMIN: `WHERE agency_id = 'mi-agency-uuid'` ‚Üí Ve solo SU agencia

---

## üë• Ejemplos Pr√°cticos

### Escenario: Sistema con 2 Tenants

```
üì¶ Base de datos:

tenants:
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ id           ‚îÇ name            ‚îÇ status ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ tenant-esp   ‚îÇ Mayorista ESP   ‚îÇ active ‚îÇ
‚îÇ tenant-mex   ‚îÇ Mayorista MEX   ‚îÇ active ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

agencies:
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ id           ‚îÇ name           ‚îÇ tenant_id  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ agency-loza  ‚îÇ lozada agency  ‚îÇ tenant-esp ‚îÇ
‚îÇ agency-team  ‚îÇ Agency Team    ‚îÇ tenant-esp ‚îÇ
‚îÇ agency-canc  ‚îÇ Viajes Canc√∫n  ‚îÇ tenant-mex ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

users:
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ email                     ‚îÇ role       ‚îÇ tenant_id  ‚îÇ agency_id  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ owner@system.com          ‚îÇ OWNER      ‚îÇ NULL       ‚îÇ NULL       ‚îÇ
‚îÇ superadmin@superadmin.com ‚îÇ SUPERADMIN ‚îÇ tenant-esp ‚îÇ NULL ‚úÖ    ‚îÇ
‚îÇ admin@lozada.com          ‚îÇ ADMIN      ‚îÇ tenant-esp ‚îÇ agency-loza‚îÇ
‚îÇ seller1@lozada.com        ‚îÇ SELLER     ‚îÇ tenant-esp ‚îÇ agency-loza‚îÇ
‚îÇ admin@agency.com          ‚îÇ ADMIN      ‚îÇ tenant-esp ‚îÇ agency-team‚îÇ
‚îÇ seller@seller.com         ‚îÇ SELLER     ‚îÇ tenant-esp ‚îÇ agency-team‚îÇ
‚îÇ superadmin-mex@mex.com    ‚îÇ SUPERADMIN ‚îÇ tenant-mex ‚îÇ NULL ‚úÖ    ‚îÇ
‚îÇ admin@cancun.com          ‚îÇ ADMIN      ‚îÇ tenant-mex ‚îÇ agency-canc‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üéØ ¬øQu√© ve cada SUPERADMIN en `/users`?

### `superadmin@superadmin.com` (Tenant: Mayorista ESP)

**Ve TODOS los usuarios del tenant "Mayorista ESP":**

```
Users List
6 users visible

Email                     | Role       | Agency        | Tenant
--------------------------|------------|---------------|---------------
superadmin@superadmin.com | SUPERADMIN | -             | Mayorista ESP ‚úÖ
admin@lozada.com          | ADMIN      | lozada agency | Mayorista ESP ‚úÖ
seller1@lozada.com        | SELLER     | lozada agency | Mayorista ESP ‚úÖ
admin@agency.com          | ADMIN      | Agency Team   | Mayorista ESP ‚úÖ
seller@seller.com         | SELLER     | Agency Team   | Mayorista ESP ‚úÖ
seller2@seller2.com       | SELLER     | Agency Team   | Mayorista ESP ‚úÖ
```

**NO ve:**
```
‚ùå superadmin-mex@mex.com  | SUPERADMIN | -            | Mayorista MEX
‚ùå admin@cancun.com        | ADMIN      | Viajes Canc√∫n| Mayorista MEX
```

**Raz√≥n:** Solo ve usuarios donde `tenant_id = 'tenant-esp'`

---

### `superadmin-mex@mex.com` (Tenant: Mayorista MEX)

**Ve TODOS los usuarios del tenant "Mayorista MEX":**

```
Users List
3 users visible

Email                  | Role       | Agency        | Tenant
-----------------------|------------|---------------|---------------
superadmin-mex@mex.com | SUPERADMIN | -             | Mayorista MEX ‚úÖ
admin@cancun.com       | ADMIN      | Viajes Canc√∫n | Mayorista MEX ‚úÖ
seller-cancun@canc.com | SELLER     | Viajes Canc√∫n | Mayorista MEX ‚úÖ
```

**NO ve:**
```
‚ùå Ning√∫n usuario de Mayorista ESP
```

---

## üèóÔ∏è Flujo: OWNER crea TENANT con SUPERADMIN

### Modal "Create Tenant" (Propuesta de UI)

```typescript
// Cuando OWNER crea un tenant:

interface CreateTenantInput {
  // Datos del Tenant
  tenant_name: string;
  tenant_status: 'active' | 'suspended';

  // Datos del SUPERADMIN (opcional)
  create_superadmin?: boolean;
  superadmin_email?: string;
  superadmin_password?: string;
  superadmin_name?: string;
}

// Ejemplo:
{
  tenant_name: "Mayorista Argentina",
  tenant_status: "active",
  create_superadmin: true,
  superadmin_email: "admin@mayorista-arg.com",
  superadmin_password: "secure123",
  superadmin_name: "Admin Argentina"
}
```

### Backend: Crear Tenant + SUPERADMIN

```sql
-- 1. Crear Tenant
INSERT INTO tenants (name, status)
VALUES ('Mayorista Argentina', 'active')
RETURNING id INTO tenant_id_var;

-- 2. Crear SUPERADMIN asignado a ese tenant
INSERT INTO auth.users (email, encrypted_password)
VALUES ('admin@mayorista-arg.com', crypt('secure123', gen_salt('bf')))
RETURNING id INTO user_id_var;

INSERT INTO public.users (id, email, role, tenant_id, agency_id)
VALUES (
  user_id_var,
  'admin@mayorista-arg.com',
  'SUPERADMIN',
  tenant_id_var,  -- ‚úÖ Asignado al tenant
  NULL            -- ‚úÖ NO asignado a agencia espec√≠fica
);
```

### Resultado:

```
El SUPERADMIN admin@mayorista-arg.com puede:
‚úÖ Ver todas las agencias del tenant "Mayorista Argentina"
‚úÖ Crear agencias dentro del tenant
‚úÖ Crear usuarios (ADMIN, SELLER) en esas agencias
‚úÖ Ver m√©tricas agregadas del tenant
‚ùå NO puede ver otros tenants
```

---

## üìã Checklist de Configuraci√≥n

### Para cada SUPERADMIN:

- [ ] ‚úÖ Tiene `tenant_id` asignado (NO NULL)
- [ ] ‚úÖ Tiene `agency_id = NULL` (sin agencia espec√≠fica)
- [ ] ‚úÖ Puede ver usuarios de TODAS las agencias de su tenant
- [ ] ‚úÖ Puede crear agencias en su tenant
- [ ] ‚úÖ Puede crear usuarios (ADMIN, SELLER) en agencias de su tenant

### Para cada ADMIN:

- [ ] ‚úÖ Tiene `tenant_id` asignado
- [ ] ‚úÖ Tiene `agency_id` asignado (UNA agencia espec√≠fica)
- [ ] ‚úÖ Solo ve SELLERS de su agencia
- [ ] ‚úÖ Puede crear SELLERS en su agencia

### Para cada SELLER:

- [ ] ‚úÖ Tiene `tenant_id` asignado
- [ ] ‚úÖ Tiene `agency_id` asignado
- [ ] ‚úÖ Solo ve s√≠ mismo
- [ ] ‚úÖ Solo ve sus leads asignados

---

## üîß Script de Correcci√≥n

**Ejecuta:** [FIX_SUPERADMIN_TENANT_MODEL.sql](FIX_SUPERADMIN_TENANT_MODEL.sql)

**Pasos:**

1. **Verificar tenants existentes**
2. **Asignar SUPERADMIN a un tenant** (`tenant_id` != NULL, `agency_id` = NULL)
3. **Actualizar pol√≠ticas RLS** (filtrar por `tenant_id` en vez de `agency_id`)
4. **Verificar** que SUPERADMIN ve todas las agencias de su tenant

---

## üéØ Ventajas del Modelo Correcto

### ‚úÖ SUPERADMIN asignado a TENANT:

1. **Gestiona TODAS las agencias del tenant** ‚Üí No necesita asignaciones m√∫ltiples
2. **Modelo simple y escalable** ‚Üí Un tenant puede tener N agencias
3. **Permisos heredados** ‚Üí SUPERADMIN autom√°ticamente ve todo el tenant
4. **Alineado con la jerarqu√≠a** ‚Üí OWNER > TENANT > SUPERADMIN > AGENCY > ADMIN > SELLER

### ‚ùå Modelo INCORRECTO (SUPERADMIN con agency_id):

1. Necesita tabla `superadmin_agency_assignments` (complejo)
2. Requiere asignaciones manuales por cada agencia
3. No escala bien si el tenant tiene muchas agencias
4. Rompe la jerarqu√≠a TENANT ‚Üí SUPERADMIN

---

## üìä Comparaci√≥n de Modelos

| Aspecto | TENANT Model ‚úÖ | Multiple Agencies Model ‚ùå |
|---------|----------------|---------------------------|
| **SUPERADMIN.tenant_id** | `tenant-uuid` | `tenant-uuid` |
| **SUPERADMIN.agency_id** | `NULL` | `NULL` |
| **Agencias visibles** | TODAS del tenant | Solo asignadas en tabla adicional |
| **Tabla adicional** | NO necesita | S√ç (`superadmin_agency_assignments`) |
| **RLS Filter** | `tenant_id = user_tenant_id` | `agency_id = ANY(get_assigned_agencies())` |
| **Complejidad** | Baja | Alta |
| **Escalabilidad** | Alta | Media |

---

## üöÄ Implementaci√≥n Recomendada

### 1. Corregir SUPERADMINs existentes

```sql
-- Asignar a tenant, quitar agency_id
UPDATE users
SET
  tenant_id = (SELECT id FROM tenants WHERE name = 'Mayorista ESP'),
  agency_id = NULL
WHERE role = 'SUPERADMIN'
  AND email = 'superadmin@superadmin.com';
```

### 2. Actualizar RLS policies

```sql
-- Usar filtro por tenant_id
CREATE POLICY "users_select_policy" ON public.users FOR SELECT TO authenticated
USING (
  -- ...
  OR (
    public.get_user_role() = 'SUPERADMIN'
    AND tenant_id = public.get_user_tenant_id()  -- ‚Üê Correcto
  )
  -- ...
);
```

### 3. UI: Modal "Create Tenant"

```typescript
// Componente React
<TenantDialog>
  <Input label="Tenant Name" />
  <Switch label="Create SUPERADMIN" />
  {createSuperadmin && (
    <>
      <Input label="SUPERADMIN Email" />
      <Input label="SUPERADMIN Password" type="password" />
      <Input label="SUPERADMIN Name" />
    </>
  )}
</TenantDialog>
```

### 4. Backend: Crear tenant + superadmin

```typescript
// Edge Function o RPC
async function createTenantWithSuperadmin(input: CreateTenantInput) {
  // 1. Create tenant
  const tenant = await supabase.from('tenants').insert({
    name: input.tenant_name,
    status: input.tenant_status
  }).select().single();

  // 2. Create superadmin if requested
  if (input.create_superadmin) {
    const { data: authUser } = await supabase.auth.admin.createUser({
      email: input.superadmin_email,
      password: input.superadmin_password,
      email_confirm: true
    });

    await supabase.from('users').insert({
      id: authUser.user.id,
      email: input.superadmin_email,
      name: input.superadmin_name,
      role: 'SUPERADMIN',
      tenant_id: tenant.id,      // ‚úÖ Asignado al tenant
      agency_id: null,           // ‚úÖ Sin agencia espec√≠fica
      provider: 'email'
    });
  }

  return tenant;
}
```

---

## ‚úÖ Resultado Final

**Con el modelo correcto:**

```
superadmin@superadmin.com (Tenant: Mayorista ESP)
‚îú‚îÄ‚îÄ Ve: lozada agency
‚îÇ   ‚îú‚îÄ‚îÄ admin@lozada.com (ADMIN)
‚îÇ   ‚îî‚îÄ‚îÄ seller1@lozada.com (SELLER)
‚îú‚îÄ‚îÄ Ve: Agency Team
‚îÇ   ‚îú‚îÄ‚îÄ admin@agency.com (ADMIN)
‚îÇ   ‚îú‚îÄ‚îÄ seller@seller.com (SELLER)
‚îÇ   ‚îî‚îÄ‚îÄ seller2@seller2.com (SELLER)
‚îî‚îÄ‚îÄ NO ve: Mayorista MEX (otro tenant)
```

---

**Fecha:** 6 de Octubre 2025
**Sistema:** WholeSale Connect AI
**Modelo:** TENANT-based SUPERADMIN (Correcto) ‚úÖ
